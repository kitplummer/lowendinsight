# Zarf Package Definition for LowEndInsight (LEI)
# For air-gapped deployment of OSS supply chain risk analysis
#
# Build:  zarf package create .
# Deploy: zarf package deploy zarf-package-lei-*.tar.zst

kind: ZarfPackageConfig
metadata:
  name: lei
  description: "LowEndInsight - OSS Supply Chain Risk Analysis Tool"
  version: "0.8.1"
  url: https://github.com/gtri/lowendinsight
  authors: Georgia Tech Research Institute
  documentation: https://github.com/gtri/lowendinsight#readme
  source: https://github.com/gtri/lowendinsight
  vendor: GTRI

variables:
  - name: LEI_REGISTRY
    description: "Container registry for LEI image"
    default: "ghcr.io/gtri"
  - name: LEI_AIRGAPPED_MODE
    description: "Enable air-gapped mode"
    default: "true"

components:
  - name: lei-image
    description: "LowEndInsight container image"
    required: true
    images:
      - "###ZARF_PKG_TMPL_LEI_REGISTRY###/lowendinsight:###ZARF_PKG_TMPL_VERSION###"
    actions:
      onCreate:
        before:
          - cmd: |
              echo "Building LEI container image..."
              docker build -f Dockerfile.prod -t ghcr.io/gtri/lowendinsight:0.8.1 .
            description: "Build LEI production container"

  - name: lei-cli
    description: "LEI command-line interface scripts"
    required: false
    files:
      - source: scripts/docker-entrypoint.sh
        target: /usr/local/bin/lei-entrypoint.sh
        executable: true

  - name: lei-config
    description: "LEI configuration files"
    required: false
    files:
      - source: config/prod.exs
        target: /etc/lei/prod.exs
      - source: schema/
        target: /etc/lei/schema/

  - name: lei-sbom
    description: "LEI Software Bill of Materials"
    required: false
    actions:
      onDeploy:
        after:
          - cmd: |
              echo "Extracting SBOM from LEI container..."
              docker run --rm ghcr.io/gtri/lowendinsight:0.8.1 sbom cyclonedx > /var/lei/sbom.cdx.json
              docker run --rm ghcr.io/gtri/lowendinsight:0.8.1 sbom spdx > /var/lei/sbom.spdx.json
            description: "Extract container SBOM"

  - name: lei-k8s
    description: "Kubernetes deployment manifests for LEI"
    required: false
    manifests:
      - name: lei-deployment
        namespace: lei
        files:
          - manifests/namespace.yaml
          - manifests/configmap.yaml
          - manifests/deployment.yaml
          - manifests/service.yaml
